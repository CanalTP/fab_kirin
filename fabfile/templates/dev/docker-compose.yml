version: '2'

services:
  kirin_config:
    image: {{env.docker_image_kirin_conf}}:{{env.current_docker_tag}}
    stdin_open: true
    restart: on-failure

  kirin:
    ports:
     - "{{env.kirin_port}}:{{env.kirin_port}}"
    image: {{env.docker_image_kirin}}:{{env.current_docker_tag}}
    restart: always
    volumes_from:
     - kirin_config
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://{{env.host_syslog}}:514"
        syslog-facility: "local7"
        syslog-tag: "kirin"

    environment:
      VIRTUAL_HOST: {{env.kirin_host}}

  kirin_background:
    image: {{env.docker_image_kirin}}:{{env.current_docker_tag}}
    restart: always
    volumes_from:
     - kirin_config
    command: python ./manage.py load_realtime
    logging:
      driver: "syslog"
      options:
        syslog-address: "tcp://{{env.host_syslog}}:514"
        syslog-facility: "local7"
        syslog-tag: "kirin"

networks:
  default:
    external:
      name: canaltp
